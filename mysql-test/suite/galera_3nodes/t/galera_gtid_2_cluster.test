#
# This test creates 2x 3 nodes galera cluster.
# The whole test case
#       A <-> B <-> C     {Galera cluster 1}
#       |                 {Circular Async replication}
#       D <-> E <-> F     {Galera cluster 2}
# We will write on any random node to see if gtid is consitent or not
# Then we will kill node D and set up the replication between A and E
# To see whether fail over works or not.

--source include/big_test.inc
--source include/galera_cluster.inc
--source include/have_innodb.inc

--connection node_1
--echo cluster 1 node 1
SHOW STATUS LIKE 'wsrep_cluster_size';

--connection node_2
--echo cluster 1 node 2
SHOW STATUS LIKE 'wsrep_cluster_size';

--connect node_3, 127.0.0.1, root, , test, $NODE_MYPORT_3
--connection node_3
--echo cluster 1 node 3
SHOW STATUS LIKE 'wsrep_cluster_size';

--connect node_4, 127.0.0.1, root, , test, $NODE_MYPORT_4
--connection node_4
--echo cluster 2 node 1
SHOW STATUS LIKE 'wsrep_cluster_size';

--connect node_5, 127.0.0.1, root, , test, $NODE_MYPORT_5
--connection node_5
--echo cluster 2 node 2
SHOW STATUS LIKE 'wsrep_cluster_size';

--connect node_6, 127.0.0.1, root, , test, $NODE_MYPORT_6
--connection node_6
--echo cluster 2 node 3
SHOW STATUS LIKE 'wsrep_cluster_size';

--connection node_1
--eval change master to master_host='127.0.0.1', master_user='root', master_port=$NODE_MYPORT_4, master_use_gtid=current_pos;
start slave;
--sleep 1
select @@gtid_binlog_state;
select @@gtid_slave_pos;
#--query_vertical SHOW SLAVE STATUS;

--connection node_4
--eval change master to master_host='127.0.0.1', master_user='root', master_port=$NODE_MYPORT_1, master_use_gtid=current_pos;
start slave;
--sleep 1
select @@gtid_binlog_state;
select @@gtid_slave_pos;
#--query_vertical SHOW SLAVE STATUS;

--connection node_1
create table t1 (cluster int ,node int);
insert into t1 values (1,1);
select @@gtid_binlog_state;

--sleep 1
--sleep 1
--connection node_4
insert into t1 values (2,1);
select @@gtid_binlog_state;
select * from t1;

--connection node_2
select @@gtid_binlog_state;
insert into t1 values (1,2);
#--connection node_3
#select @@gtid_binlog_state;
#insert into t1 values (1,3);
#--connection node_5
#select @@gtid_binlog_state;
#insert into t1 values (2,2);
#--connection node_6
#select @@gtid_binlog_state;
#insert into t1 values (2,3);

--connection node_1
drop table t1;
stop slave;
change master to master_use_gtid=no;

--connection node_4
stop slave;
change master to master_use_gtid=no;
